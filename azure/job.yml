$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json
display_name: mem-train-rw
experiment_name: xcernansky-train
code: .
environment: azureml:xcernansky-5@latest
compute: azureml:cernansky-tesla-t4

resources:
  shm_size: "8g"   # enlarge /dev/shm for DataLoader

# RW-mounted dataset input (you can read AND write here)
inputs:
  ds_root:
    type: uri_folder
    mode: ro_mount
    path: "azureml://subscriptions/bc82dccd-f19d-42cb-9ce3-0d5df33ef086/resourcegroups/a0047-STUFIIT-ML01/workspaces/a0047stufiitml01/datastores/workspaceblobstore/paths/datasets/xcernansky_datasets/"

outputs:
  ckpts:
    type: uri_folder
    mode: rw_mount 
    path: "azureml://subscriptions/bc82dccd-f19d-42cb-9ce3-0d5df33ef086/resourcegroups/a0047-STUFIIT-ML01/workspaces/a0047stufiitml01/datastores/workspaceblobstore/paths/datasets/xcernansky_datasets/checkpoints"

environment_variables:
  OMP_NUM_THREADS: "1"
  MKL_NUM_THREADS: "1"

command: |
  bash -lc '
  echo "== /dev/shm =="; df -h /dev/shm
    echo "== Clone =="
  git clone --recurse-submodules https://github.com/RichardCernansky/xmem_trajectory.git app
  cd app 
  curl -L -o XMem/XMem-s012.pth \
      https://github.com/hkchengrex/XMem/releases/download/v1.0/XMem-s012.pth
  ls -lh XMem/XMem-s012.pth

  # Paths inside the mounted input
  ROOT="${{inputs.ds_root}}"
  DATA="$ROOT/nuscenes"
  TRAIN_IDX="$ROOT/indexes/run-get-2000/train_agents_index.pkl"
  VAL_IDX="$ROOT/indexes/run-get-2000/val_agents_index.pkl"
  CKPTS="$ROOT/checkpoints"   # RW because input is rw_mount

  echo "DATA=$DATA"
  echo "TRAIN_IDX=$TRAIN_IDX"
  echo "VAL_IDX=$VAL_IDX"
  echo "CKPTS=$CKPTS"


  python -m trainer.trainer \
    --model_name memv1 \
    --version v1.0-trainval \
    --dataroot "$DATA" \
    --train_index "$TRAIN_IDX" \
    --val_index "$VAL_IDX" \
    --checkpoints_dir "$CKPTS" \
    --epochs 50 \
  '
